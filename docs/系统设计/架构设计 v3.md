[[toc]]

# 自定义平台 3.0 - 前端架构设计 v3

---

## 1. Changelog

| 作者 | 更新日期 | 版本 | 更改内容 |
|---|---|---|---|
| 相杰 | 2020-06-03 | v2.0.0 | 初稿 |
| 相杰 | 2020-06-04 | v2.1.0 | 根据评审进行调整，[更改日志](https://www.tapd.cn/41909965/documents/show/1141909965001000961) |
| 相杰 | 2020-06-05 | v2.1.1 | 调整 IUB-DSL 模型, 添加页面间的输入输出流向 |
| 相杰 | 2020-07-02 | v3.0.0 | 1. 添加编写目的和范围<br>2. 添加核心名词解释<br>3. 调整优化文档上下文内容<br>4. 添加系统设计思路<br>5. 添加核心模块引用<br>6. 优化分层架构图<br>7. 优化模块交互图 |
| 相杰 | 2020-07-08 | v3.1.0 | 1. 明确 IUB-DSL 的边界<br>2. 明确页面设计器的边界<br>3. 明确 node 服务的职责 |
| 相杰 | 2020-07-23 | v3.2.0 | 1. 调整系统模块的关系<br>2. 明确 IUB-DSL 生成规则 |
| 相杰 | 2020-07-28 | v3.3.0 | 1. 优化文档目录<br>2. 完善业务领域模型<br>3. 完善系统领域模型<br>4. 完善系统分层图<br>5. 添加前端基础设施说明<br>6. 添加前端动态资源支持服务说明<br>7. 添加「应用平台 - 前端」线上修复方案说明<br>8. 添加设计原则 |
| 相杰 | 2020-08-10 | v3.3.1 | 1. 统一名词`配置端动态资源服务`<br>2. 根据评审建议调整模块图 |

---

## 2. 引言

### 2.1. 背景

经过一段时间的对业务的调研和思考，对如何设计可以`满足 and 易于扩展业务需求`的系统有更清晰脉络。于是我们重新整理了一份`渐进式`的架构设计，来指导系统有计划的实施。

我们基于业务需求，深度剖析`配置端`和`应用端`，参考过去的经验进行总结，明确了各个模块（前端模块）的职能、交互接口和边界，希望可以打造良好的产品。

### 2.2. 业务痛点

由于自定义平台 2.x 前端的规划路线，暴露出一些问题，这些问题在后期维护中不断被放大，导致在维护和扩展都不尽人意，应对更多业务时显得有点力不从心。

| 自定义平台 2.x 前端问题 | 自定义平台 3.0 优化方案 |
|---|---|
| 模块划分不清晰，导致模块改动导致对系统的产生不可预测的影响 | 有更详细的设计文档，做好`核心模块`的`职责`与`输入输出`的设计 |
| 缺少确保模块改动不影响其他模块的机制（单元测试） | 将采用测试驱动开发 TDD 的方式保障核心模块稳定 |
| 缺乏让规则落地的方案 | 将所有规则落地 |
| 技术术语不统一不明确 | 明确所有技术术语 |
| 项目架构缺乏扩展性 | 采用 lerna and yarn workspace 管理模块 |
| 代码质量一般 | 采用 typescript 保证代码质量 |

### 2.3. 设计原则

1. 第一原则：指导业务拆解与系统设计
   1. 指导业务需求拆解
   2. 指导系统设计
2. 原子设计原则： 系统架构原则，从最小单元考虑
3. 单向数据流确保数据正确性
4. 解析引擎支撑系统核心
5. 领域模型指导功能模块设计
6. 单元测试先行：保障核心模块的稳定性
7. 规则必须有落地方案，否则不制定规则
8. SOLID

### 2.4. 设计类型说明

#### 2.4.1. 系统设计

1. 支持业务需求的系统所需要的技术模块
2. 技术模块的边界
3. 指导`方案设计`

#### 2.4.2. 方案设计

用于指导模块的`开发`与`详细设计`。

#### 2.4.3. 详细设计

用于说明模块的设计思路、开发过程。

### 2.5. 知识落地

除了有设计文档，我们还可以录制一些教学视频来让知识落地

1. 通过文档将系统知识落地
2. 视频解说：当系统内核框架开发完成后，便进入接入新人开发业务的阶段。这个时候我们可以录制关于系统关键部分的视频解说，来指导新人的接入

### 2.6. 建立影响力

我们可以对外建立有影响力的前端团队形象，用以吸引更多优秀的人加入团队。

---

## 3. 编写目的和范围

- 深入浅出自定义工具 3.0 前端架构
  - 非技术可明白系统能力
  - 初级技术可明白运行原理
  - 中级技术可接入通用模块的设计、开发与维护
  - 高级技术可接入核心模块的设计、开发与维护
- 统一所有术语的概念
- 指导子模块、子应用、子系统的设计

---

## 4. 术语

| 技术术语 | 含义 |
|---|---|
| 模块（module） | 一组能独立完成特定功能的`函数组合`（其中包括运行容器、函数、解析器、引擎等）。|
| 解析（parse） | 将`文件`或`其他输入`拆分为易于`存储或操纵`的数据。|
| 解析器（parser） | 接受一种`数据结构`，输出`另一种数据结构`的`函数或模块`。|
| 数据转换器（data transformer） | 一种转换特定数据类型的函数模块。|
| 引擎（engine） | 一种提供特定抽象能力、通过接口制定其中的内容表现行为，同时提供数据`解析和运行`的`模块或系统`。<br>_例如游戏物理引擎，提供模拟物理世界的重力、碰撞等能力，开发游戏者只需按照规定的接口，便能开发出符合物理世界规律的游戏_。|
| 可视化编辑器引擎（VisualEditor engine） | 通过抽象出提供`拖拽`、`实例化组件`、`编辑属性`等能力的引擎模块。|
| IUB-DSL 引擎 | 拥有`解析`、`执行`、`渲染` IUB-DSL 的能力的引擎模块。|
| 布局渲染引擎 | 提供布局渲染能力、UI 交互能力的引擎模块。|
| 上下文（context） | 模块在执行时产生的作用域环境，表现为`变量集合`、`作用域链`。|
| 容器（container） | 用于隔离模块运行环境，并提供存放`运行时状态`、`上下文`功能的模块。|
| 运行时状态（runtime state） | 运行容器在运行过程中产生的`变量数据`。|
| 静态数据（static data） | 独立于系统存在的数据，也是系统最终产出的数据。|
| 调度器（dispatcher） | 根据需要处理的数据的类型，调用对应的`模块`进行处理的函数。|
| 编译（compile） | 将一种代码转成另一种在`代码运行器`中可运行的代码.|
| 渲染器（renderer） | 将数据`渲染到浏览器`的模块。|
| 构造器（constractor） | 用于`实例化类`的函数。|
| 生成器（generator） | 用于重载一个类生成另一种类的`工厂函数`。|
| 过滤器（filter） | 按照一定规则筛选输入数据的函数，`输入输出的数据类型一致`。|

| 其他术语 | 含义 |
|---|---|
| 规则（rule） | 行为约定，包括人员思维、行为的约定，系统的模块交互约定。|
| 业务（business） | 来自真实世界的、由人的需求驱动的`选择流程控制`。<br>在代码上表示为根据实际需求的程序`执行流程控制`。 |

---

## 5. 设计思路

### 5.1. 第一原则

根据`第一原则`的指导，我们通过 `分析业务需求` -> `拆解最小业务单元` -> `找到线索` -> `总结规律` -> `建立模型` -> `设计系统` -> `实施工程` 的方式来指导业务拆解，在根据`原子设计原则`来指导前端架构的设计。

### 5.2. 原子设计原则

我们的世界由最小原子（目前是玻色子）按照一定的规律组成：`原子` -> `分子` -> `物质` -> `个体` -> `整体`。

在根据第一原则拆解`最小业务单元`后，找到其中的`规律`，并且制定一些规则，来保证`最小业务单元`在系统的能力范围之内稳定运行，以下便是规则的更详细叙述。

### 5.3. 规则

无规则不成方圆，但是规则需要落地才能确保能被持续遵守。所以我们不仅仅是制定规则，而且通过`工具`来保证规则要被遵守。

| 规则 | 工具 | 自定义平台 2.x 是否支持 | 自定义平台 3.0 是否支持 |
|---|---|---|---|
| 开发人员接入规则 | Eslint<br>Typescript | ✖️ | ✔️ |
| 单元测试规则(80%覆盖率) | Jest<br>Cypress | ✖️ | ✔️ |
| 应用平台运行规则 | IUB-DSL | ✖️ | ✔️ |
| 模块边界 | 系统领域模型图 | ✖️ | ✔️ |

### 5.4. 需要满足的业务范围比例

![图片描述](/tfl/pictures/202008/tapd_41909965_1596335729_28.png)

---

## 6. 业务领域模型

### 6.1. 总揽

我们的`可视化 - 低代码生产平台`是一种典型的`生产者与消费者`模式，我们将配置平台视为`生产者`，应用平台视为`消费者`：

![图片描述](/tfl/pictures/202007/tapd_41909965_1596009750_82.png)

---

### 6.2. 配置平台

1. 配置人员通过`配置平台`的可视化操作，产出可以直接应用于业务场景的系统
2. 配置平台赋予`配置人员`极高的生产力
3. 产出的`应用实例`拥有`业务数据录入`、`业务数据展示`、`物联网控制`等功能
4. 可以通过插件来扩展`配置平台`的能力

![图片描述](/tfl/pictures/202008/tapd_41909965_1597063145_2.png)

### 6.3. 应用平台

`应用实例`拥有`业务数据录入`、`业务数据展示`、`物联网控制`等为特定领域制定的业务功能：

![图片描述](/tfl/pictures/202008/tapd_41909965_1597063176_75.png)

---

## 7. 系统领域模型

根据业务领域模型，我们开始着手设计系统来支撑业务。

### 7.1. 应用生命周期模型

我们先从应用的生命周期开始，指导我们的前后端模块设计的关键点：

![图片描述](/tfl/pictures/202008/tapd_41909965_1597111565_27.png)

---

### 7.2. 配置平台

#### 7.2.1. 要求

1. `配置平台 前端`的资源需要支持动态扩展，例如页面设计器的组件接入，低代码编辑器内置函数等
2. 需要在一个浏览器页签中打开多个`子页面`，`子页面`需要互相能通讯
3. 需要记录用户的操作链路

#### 7.2.2. 前端模块

![图片描述](/tfl/pictures/202008/tapd_41909965_1597063871_35.png)

#### 7.2.3. 配置端动态资源服务

1. 为了提高页面设计器的扩展能力，所以考虑将`组件类`和`属性项`的资源管理交给前端开发人员。这样可以做到`页面设计器`与`组件类`解偶，页面设计器动态加载组件与属性
2. 同理可以作用于低代码

![图片描述](/tfl/pictures/202008/tapd_41909965_1597063238_66.png)

---

### 7.3. 应用平台

#### 7.3.1. 要求

1. 需要根据`配置人员`通过`配置平台`产出的业务规则准确无误的运行
2. 需要考虑不同的`壳容器`的内嵌，例如`流程容器`、`WPF`等
3. 需要支持`页面变量`、`控件数据联动`、`运行低代码片段`等各种能力
4. 需要不受`应用平台服务`的运行状态影响，保证 web 稳定运行
5. 需要有现场问题修复方案

#### 7.3.2. 前端模块

![图片描述](/tfl/pictures/202008/tapd_41909965_1597063326_73.png)

#### 7.3.3. 现场问题修复方案（草案）

![图片描述](/tfl/pictures/202008/tapd_41909965_1597063552_62.png)

---

## 8. 系统分层设计

> 终极目标：最大化程序员的生产力，最小化运营维护成本。

### 8.1. 系统架构设计思路

`前端基础设施` -> `内核` -> `引擎` -> `业务插件` -> `子应用` -> `系统`。

![图片描述](/tfl/pictures/202007/tapd_41909965_1596011439_66.png)

核心思路是：核心能力由`引擎`提供，`业务`作为`插件`的形式插入到引擎运行，最终通过`内核`将多个引擎集合起来组成不同的`子应用`，最终成为可支持实际业务场景的`系统`。

---

### 8.2. 前端基础设施

当我们需要启动前端应用的开发的时候，往往会做很多重复的工作：

1. 技术选型
2. 工程目录划分、搭建、后期维护管理等
3. 通用模块，例如 `HTTP/WS` 模块，`UI`库等
4. 单元测试
5. ...

这些无论是什么前端项目，都是需要的，我们称之为`前端基础设施`。我们可以基于`前端基础设施`快速开启应用的开发，同时也方便后期的项目维护：

![图片描述](/tfl/pictures/202007/tapd_41909965_1596011451_40.png)

#### 8.2.1. 基础设施赋能

1. 通过 lerna 和 yarn workspace 提供的模块管理，赋予项目极高的可扩展性、可维护性
   1. 关键模块的依赖不再使用`相对路径`
2. 每个子应用可独立开发、调试、部署

---

### 8.3. 配置平台

1. 配置平台前端基于`前端基础设施`

![图片描述](/tfl/pictures/202009/tapd_41909965_1598942895_86.png)

### 8.4. 应用平台

1. 应用平台前端基于`前端基础设施`

![图片描述](/tfl/pictures/202007/tapd_41909965_1596079589_18.png)

---

## 9. 定制开发方案（草案）

### 9.1. 定制页面

- 通过 IUB-DSL 描述定制页面的元数据信息
- 定制开发者通过定制接入标准开发。最终的目标是在自定义平台中内置 web IDE（在线 vscode），web IDE 提供完整的开发依赖。

![图片描述](/tfl/pictures/202006/tapd_41909965_1592617811_41.jpg)

### 9.2. 定制组件

同定制页面

---

## 10. 设计集合

### 10.1. 方案设计

- [页面设计器 - 李佳](TODO)
- [IUB-DSL 引擎 - 国才](https://www.tapd.cn/41909965/documents/show/1141909965001001077?file_type=word)
- [低代码编辑器 - 东亮](TODO)
- [日志模块 - 东亮](TODO)
- [应用平台 - 前端运行方案（原 IUB-DSL 工作原理） - 相杰](https://www.tapd.cn/41909965/documents/show/1141909965001001298)
- [前端动态资源 web 服务（待定） - 相杰](https://www.tapd.cn/41909965/documents/show/1141909965001001064?file_type=word)
- [低代码引擎 - 相杰](https://www.tapd.cn/41909965/documents/show/1141909965001001318)
- [工程化 - 鹏辉](TODO)

### 10.2. 接口文档

- [通用 UI 组件接入标准 - 相杰](https://www.tapd.cn/41909965/documents/show/1141909965001001153)
- [多页面路由机制方案 - 相杰](https://www.tapd.cn/41909965/documents/show/1141909965001001066)
- [权限控制方案 - 相杰](https://www.tapd.cn/41909965/documents/show/1141909965001001065)
- [可视化编辑器引擎 - 相杰](https://www.tapd.cn/41909965/documents/show/1141909965001001350)
- [定制接入方案 - TODO](TODO)
- [数据转换器 - 鹏辉](TODO)

### 10.3. 详细设计

- [业务应用方案 - 鹏辉](TODO)：
  - 数据设计
  - 权限管理
  - 菜单管理
  - ...

---

## 11. 最后

感谢大家的观看。
